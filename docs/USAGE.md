# Overview

The ðŸ¥‘ gem is a [Rails Engine] composed of a mixture of Ruby modules that get
included into application classes and Ruby classes which will run directly from
the ðŸ¥‘ gem itself. The classes are intended to provide good defaults for basic
scenarios, and can be subclassed and overridden for special cases.

## Requirements

Apps must be running Rails 7.1 or newer. The ðŸ¥‘ gem uses features like
`authenticate_by`, `has_secure_password`, `generates_token_for`, and
`normalizes` which don't exist in earlier versions.

The database schema must have columns that match the `users`, `sessions`, and
`events` tables from the [demo app schema]. More columns in each table are
acceptable; the demo is just a minimum. Slight variations (using `uuid` instead
of `bigint` for example) are harmless, but large departures will break the
integration.

The application must also have:

- An `ApplicationController` base controller class
- An `ApplicationMailer` base mailer class
- A `root_path` method (typically generated by application routes)

## Usage

### Models

Include these modules into `ActiveRecord` model classes:

```ruby
class User < ApplicationRecord
  include Avocado::User
end

class Session < ApplicationRecord
  include Avocado::Session
end

class Event < ApplicationRecord
  include Avocado::Event
end
```

This will set up some basic associations, validations, callbacks, and
normalizations for those models.

### Controllers

Add the `Avocado::Authentication` module to the top-level controller:

```ruby
class ApplicationController < ActionController::Base
  include Avocado::Authentication
end
```

### Routes

The ðŸ¥‘ gem does not add any routes to the application when initialized. To hook
up the controllers to routes, they must be added to the `config/routes.rb` of
the application. It's possible to add all of the routes, or just a subset.

Example that defines a root route and also pulls in every feature route:

```ruby
Rails.application.routes.draw do
  root to: "records#index"
  draw(ðŸ¥‘)
end
```

Example that adds only the sign-up, sign-in, and sign-out actions:

```ruby
Rails.application.routes.draw do
  root to: "records#index"
  scope module: :avocado do
    resources :registrations, only: %i[new create]
    resources :sessions, only: %i[new create destroy]
  end
end
```

## Summary

### Routable controller features

The ðŸ¥‘ gem will create REST-ful routes that go to the various controllers during
app initialization.

These external (unauthenticated) features are available:

- `Registrations` -- Fill out new form and create users
- `Sessions` -- Sign in and sign out features
- `Recoveries` -- Trigger password reset, click link, confirm
- `Verifications` -- Email confirmation on account creation or email change
- `Affirmations` -- Provides a "passwordless" auth via emailed link

These internal (authenticated) features are available:

- `Sessions` -- List active sessions, click to destroy untrusted ones
- `Events` -- List view of user activity audit log
- `Passwords` -- Edit and update user password
- `Emails` -- Edit and update user email

Linking to any of these internal pages is optional. Apps can use them as-is,
override their views, or even ignore them entirely and make local versions.

### Mailers

There is an `Avocado::Mailer` which gets called to send emails. The mailer views
here are very basic, and should be overriden within applications. Place views
within `app/views/avocado/mailer/` to make this happen.

### Before actions

There is an `authenticate` method installed as a default `before_action`. Any
actions which do not need to be authenticated should disable this with
`skip_before_action`.

There is a `set_current_request_details` method installed as a default
`before_action` which takes some loggable request meta information (user agent,
IP address) and sets its value in `Current` so that its accesible to code
elsewhere in the ðŸ¥‘ gem.

### Helpers

The `Avocado::Authentication` module included into the application controller
provides some helper methods available in controllers, views, and helpers:

- `signed_in?` is true if the session has a signed in user
- `current_session` provides the DB record for the session, if one exists
- `current_user` returns the user belonging to that session

Usage of these can be seen in the views in the [demo app].

## Customization

There is not any configuration. To override functionality:

- Redefine a method created in one of the models by the included module
- Subclass a controller and update the routing to go to the subclass
- Place views in the app where avocado expects them to override the defaults

## Examples

There is a [demo app] used by the specs which has some example usage.

[demo app schema]: https://github.com/tcuwp/avocado/blob/main/spec/internal/db/schema.rb
[demo app]: https://github.com/tcuwp/avocado/blob/main/spec/internal
[Rails Engine]: https://guides.rubyonrails.org/engines.html#what-are-engines-questionmark